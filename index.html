<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Unblock Me game</title>
<style>
  :root{
    --cell: 80px;         /* –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏ */
    --gap: 6px;           /* –ø—Ä–æ—Å–≤–µ—Ç –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ (–≤–∏–∑—É–∞–ª—å–Ω—ã–π) */
    --board: #deb887;     /* –¥–µ—Ä–µ–≤–æ */
    --rim: #5c3b1e;       /* –æ–∫–∞–Ω—Ç–æ–≤–∫–∞ */
    --bg1: #f7efe1;       /* —Ñ–æ–Ω –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ 1 */
    --bg2: #d4b483;       /* —Ñ–æ–Ω –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ 2 */
    --brand: #6a3fc1;     /* —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç */
    --text: #2b2117;
    --card: #ffffff;
    --muted: rgba(43,33,23,.75);
    --grid: rgba(0,0,0,.085);
    --accent-ghost: #efe9ff;
  }
  body.theme-dark{
    --board: #4a3525;
    --rim: #2a1b12;
    --bg1: #17151a;
    --bg2: #0e0d10;
    --brand: #9a7cff;
    --text: #e8e4f0;
    --card: #1f1b24;
    --muted: rgba(232,228,240,.75);
    --grid: rgba(255,255,255,.09);
    --accent-ghost: #2c2735;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    background: radial-gradient(1000px 700px at 30% -10%, var(--bg1), transparent),
                radial-gradient(800px 600px at 120% 120%, var(--bg2), transparent),
                linear-gradient(135deg, var(--bg1), var(--bg2));
    color:var(--text);display:flex;align-items:center;justify-content:center;padding:18px
  }
  .screen{display:none;width:100%;max-width:1100px}
  .screen.active{display:block}
  .card{background:var(--card);border-radius:20px;box-shadow:0 18px 60px rgba(0,0,0,.15);padding:24px}
  h1{margin:0 0 12px;font-weight:900}
  .muted{opacity:.75;color:var(--muted)}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  .spacer{height:12px}

  /* –ö–Ω–æ–ø–∫–∏ */
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 18px;font-weight:800;cursor:pointer;
       background:linear-gradient(180deg,#8b5a2b,#70451f);color:#fff;box-shadow:0 4px 0 rgba(0,0,0,.2);transition:transform .06s ease, box-shadow .06s ease}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 0 rgba(0,0,0,.2)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:linear-gradient(180deg,#e9e4f8,#d7cef3);color:var(--text)}
  .btn.ghost{background:transparent;border:2px solid rgba(0,0,0,.1);color:var(--text)}
  .btn.toggle{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#3b3f8c,#2b2f6c)}
  .btn.small{padding:8px 12px;border-radius:10px;font-size:14px}

  /* –î–æ—Å–∫–∞ */
  #stage{display:flex;gap:24px;align-items:flex-start;justify-content:center;flex-wrap:wrap}
  #boardWrapper{position:relative}
  #board{
    position:relative;
    width: calc(var(--cell)*6 + 16px);
    height: calc(var(--cell)*6 + 16px);
    border:8px solid var(--rim);border-radius:14px;overflow:visible;
    background: var(--board);
    box-shadow:0 16px 40px rgba(0,0,0,.25), inset 0 0 0 1px rgba(0,0,0,.08)
  }
  /* –µ–ª–µ –∑–∞–º–µ—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ */
  #board::after{
    content:"";position:absolute;left:8px;top:8px;width:calc(var(--cell)*6);height:calc(var(--cell)*6);
    background:
      repeating-linear-gradient(to right, var(--grid), var(--grid) 1px, transparent 1px, transparent var(--cell)),
      repeating-linear-gradient(to bottom, var(--grid), var(--grid) 1px, transparent 1px, transparent var(--cell));
    pointer-events:none;border-radius:8px;opacity:.28
  }
  /* –ü—Ä–æ—ë–º –≤—ã—Ö–æ–¥–∞ —Å–ø—Ä–∞–≤–∞, –ø–æ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ, —á—Ç–æ –∏ –∫—Ä–∞—Å–Ω—ã–π –±–ª–æ–∫ */
  #exit{position:absolute;right:-8px;width:16px;height:var(--cell);top:calc(8px + var(--exit-row, 2)*var(--cell));background:var(--bg1);border-radius:3px;z-index:2}

  .block{position:absolute;user-select:none;touch-action:none;cursor:grab;border-radius:10px;
         box-shadow:inset -3px -5px 10px rgba(0,0,0,.25), 0 4px 12px rgba(0,0,0,.18);
         background:#c89f72; transition: transform .25s ease, left .1s, top .1s}
  .block.red{background:#e03b3b}
  .block.active{outline:3px solid rgba(255,255,255,.6);box-shadow:0 0 0 4px rgba(106,63,193,.35), inset -3px -5px 10px rgba(0,0,0,.25)}

  /* HUD */
  .hud{min-width:290px}
  .stat{font-weight:800}
  .pill{display:inline-block;background:var(--accent-ghost);color:#3d287f;padding:6px 10px;border-radius:999px;font-weight:800}
  .sep{height:1px;background:#eee2cf;margin:12px 0}
  .stars{font-size:22px;letter-spacing:2px}

  /* Level Select */
  #levelGrid{display:grid;grid-template-columns:repeat(5, minmax(90px, 1fr));gap:12px}
  .lvlBtn{position:relative;display:flex;align-items:center;justify-content:center;height:70px;border-radius:12px;
          background:linear-gradient(180deg,#ffffff,#f3f0e7);border:2px solid rgba(0,0,0,.06);font-weight:900;cursor:pointer}
  body.theme-dark .lvlBtn{background:linear-gradient(180deg,#2b2733,#241f2a);border-color:rgba(255,255,255,.06)}
  .lvlBtn.locked{opacity:.55;cursor:not-allowed}
  .lvlBtn .lock{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:22px}

  /* Overlay –ø–æ–±–µ–¥—ã */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:18px;z-index:99}
  #overlay.show{display:flex}
  #overlay .dialog{background:var(--card);color:var(--text);padding:22px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.4);text-align:center;min-width:320px}

  /* Badges */
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800}
  .badge.good{background:#e9f8ef;color:#0c6b2e}
  .badge.info{background:#eaf1ff;color:#163a9a}
  .badge.warn{background:#fff3d6;color:#7a5606}

  /* Hint UI */
  .hintPulse{position:absolute;border:3px dashed rgba(255,255,255,.8);border-radius:10px;pointer-events:none;animation:pulse 1s ease-in-out infinite}
  @keyframes pulse{0%{opacity:.2}50%{opacity:.8}100%{opacity:.2}}

  /* Toast –º–∞–ª–µ–Ω—å–∫–∏—Ö –∞—á–∏–≤–æ–∫ */
  #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--card);color:var(--text);border-radius:10px;padding:10px 14px;box-shadow:0 10px 30px rgba(0,0,0,.3);display:none;z-index:120;font-weight:800}
</style>
</head>
<body>
  <!-- MENU -->
  <section id="menu" class="screen active">
    <div class="card" style="text-align:center">
      <h1>Unblock Me ‚Äî –±—Ä–∞—É–∑–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è</h1>
      <p class="muted">15 —É—Ä–æ–≤–Ω–µ–π, –ø–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ, –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</p>
      <div class="spacer"></div>
      <div class="row" style="justify-content:center">
        <button class="btn" id="playBtn">–ò–≥—Ä–∞—Ç—å</button>
        <button class="btn secondary" id="chooseBtn">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</button>
        <button class="btn ghost" id="achBtn">–ê—á–∏–≤–∫–∏</button>
        <button class="btn toggle" id="themeBtn">–¢–µ–º–∞: <span id="themeName">–°–≤–µ—Ç–ª–∞—è</span></button>
      </div>
      <div class="spacer"></div>
      <div class="muted">–ù–∞–∂–º–∏ ¬´–ú–µ–Ω—é¬ª, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è —Å—é–¥–∞ –∏–∑ –∏–≥—Ä—ã.</div>
    </div>
  </section>

  <!-- LEVEL SELECT -->
  <section id="levelSelect" class="screen">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</h2>
        <div class="row">
          <button class="btn ghost" id="backFromSelect">–ú–µ–Ω—é</button>
        </div>
      </div>
      <div class="spacer"></div>
      <div id="levelGrid"></div>
      <div class="spacer"></div>
      <span class="muted">üîí ‚Äî –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö. ‚≠ê ‚Äî —Ç–≤–æ–π –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</span>
    </div>
  </section>

  <!-- GAME -->
  <section id="game" class="screen">
    <div class="card">
      <div id="stage">
        <div id="boardWrapper">
          <div id="board"><div id="exit"></div></div>
        </div>
        <div class="hud">
          <div class="pill">–£—Ä–æ–≤–µ–Ω—å: <span id="levelLabel">1</span> / <span id="levelTotal">15</span></div>
          <div class="spacer"></div>
          <div class="stat">–•–æ–¥—ã: <span id="moves">0</span></div>
          <div class="stars" id="stars">‚òÜ‚òÜ‚òÜ</div>
          <div class="sep"></div>
          <div class="row">
            <button class="btn secondary small" id="hintBtn">–ü–æ–¥—Å–∫–∞–∑–∫–∞ (x<span id="hintLeft">3</span>)</button>
            <button class="btn secondary small" id="undoBtn">–û—Ç–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="sep"></div>
          <div class="row">
            <button class="btn secondary" id="resetBtn">–°–±—Ä–æ—Å —É—Ä–æ–≤–Ω—è</button>
            <button class="btn secondary" id="toSelectBtn">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</button>
            <button class="btn ghost" id="toMenuBtn">–ú–µ–Ω—é</button>
            <button class="btn toggle" id="themeBtnInGame">–¢–µ–º–∞: <span id="themeName2">–°–≤–µ—Ç–ª–∞—è</span></button>
          </div>
          <div class="spacer"></div>
          <div class="badge info">–°–æ–≤–µ—Ç</div>
          <div class="muted">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –¥–≤–∏–≥–∞—é—Ç—Å—è –ø–æ X, –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ ‚Äî –ø–æ Y. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —É –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- WIN OVERLAY -->
  <div id="overlay">
    <div class="dialog">
      <h2 style="margin:0 0 6px">–ü–æ–±–µ–¥–∞! üéâ</h2>
      <div id="winStars" style="font-size:28px">‚òÜ‚òÜ‚òÜ</div>
      <p class="muted" id="winText">–ö—Ä–∞—Å–Ω—ã–π –±–ª–æ–∫ –¥–æ—Å—Ç–∏–≥ –≤—ã—Ö–æ–¥–∞.</p>
      <div class="spacer"></div>
      <div class="row" style="justify-content:center">
        <button class="btn" id="nextBtn">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
        <button class="btn secondary" id="closeWinBtn">–í –≤—ã–±–æ—Ä —É—Ä–æ–≤–Ω–µ–π</button>
      </div>
    </div>
  </div>

  <!-- ACHIEVEMENTS OVERLAY -->
  <div id="achOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:110">
    <div class="dialog" style="background:var(--card);color:var(--text);padding:22px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.4);min-width:360px">
      <h2 style="margin:0 0 10px">–ê—á–∏–≤–∫–∏</h2>
      <div id="achList" class="muted"></div>
      <div class="spacer"></div>
      <div class="row" style="justify-content:center"><button class="btn ghost" id="closeAch">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
  </div>

  <div id="toast"></div>

<script>
(()=>{
  // ======= –°–û–°–¢–û–Ø–ù–ò–ï/DOM =======
  const SIZE = 6;
  const CELL = 80; // px
  const HINTS_PER_LEVEL = 3;
  const UNDO_DEPTH = 2;
  const board = document.getElementById('board');
  const exitHole = document.getElementById('exit');
  const movesEl = document.getElementById('moves');
  const levelLabel = document.getElementById('levelLabel');
  const levelTotalEl = document.getElementById('levelTotal');
  const overlay = document.getElementById('overlay');
  const nextBtn = document.getElementById('nextBtn');
  const closeWinBtn = document.getElementById('closeWinBtn');
  const playBtn = document.getElementById('playBtn');
  const chooseBtn = document.getElementById('chooseBtn');
  const backFromSelect = document.getElementById('backFromSelect');
  const resetBtn = document.getElementById('resetBtn');
  const toSelectBtn = document.getElementById('toSelectBtn');
  const toMenuBtn = document.getElementById('toMenuBtn');
  const levelGrid = document.getElementById('levelGrid');
  const hintBtn = document.getElementById('hintBtn');
  const hintLeftEl = document.getElementById('hintLeft');
  const undoBtn = document.getElementById('undoBtn');
  const starsEl = document.getElementById('stars');
  const winStarsEl = document.getElementById('winStars');
  const toast = document.getElementById('toast');
  const achBtn = document.getElementById('achBtn');
  const achOverlay = document.getElementById('achOverlay');
  const achList = document.getElementById('achList');
  const closeAch = document.getElementById('closeAch');
  const themeBtn = document.getElementById('themeBtn');
  const themeBtnInGame = document.getElementById('themeBtnInGame');
  const themeName = document.getElementById('themeName');
  const themeName2 = document.getElementById('themeName2');

  let currentLevel = 0;
  let moves = 0;
  let blocks = [];
  let nodes = new Map(); // id -> DOM
  let dragging = null;
  let dragStart = null; // {x,y} pointer
  let startPos = null;  // {x,y} block pos
  let exitRow = 2;
  let undoStack = [];
  let hintsLeft = HINTS_PER_LEVEL;
  let hintArtifact = null; // DOM-–ø–æ–¥—Å–≤–µ—Ç–∫–∞
  let usedHintThisLevel = false;

  // ======= –£–†–û–í–ù–ò (15 —à—Ç—É–∫, —É—Å–ª–æ–∂–Ω—è—é—Ç—Å—è) =======
  // –§–æ—Ä–º–∞—Ç –±–ª–æ–∫–∞: {x,y,w,h, red?:true}
  const LEVELS = [
    // 1. –†–∞–∑–º–∏–Ω–∫–∞
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:3,y:0,w:1,h:3}, {x:5,y:0,w:1,h:2}, {x:0,y:0,w:1,h:3},
      {x:2,y:3,w:1,h:3}, {x:0,y:5,w:2,h:1}, {x:1,y:0,w:2,h:1}
    ],
    // 2
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:3,y:0,w:1,h:3}, {x:2,y:3,w:2,h:1}, {x:1,y:3,w:1,h:3},
      {x:5,y:0,w:1,h:2}, {x:0,y:0,w:2,h:1}, {x:0,y:4,w:1,h:2}
    ],
    // 3
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:3,y:0,w:1,h:3}, {x:4,y:2,w:1,h:3}, {x:2,y:1,w:3,h:1},
      {x:0,y:4,w:3,h:1}, {x:0,y:0,w:1,h:3}, {x:5,y:0,w:1,h:2}, {x:2,y:4,w:1,h:2}
    ],
    // 4 ‚Äî –±–æ–ª—å—à–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –±–∞—Ä—å–µ—Ä–æ–≤ —Å–ø—Ä–∞–≤–∞
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:4,y:0,w:1,h:3},{x:3,y:0,w:1,h:2},{x:5,y:2,w:1,h:3},
      {x:0,y:1,w:2,h:1},{x:0,y:3,w:3,h:1},{x:2,y:4,w:1,h:2}
    ],
    // 5 ‚Äî –¥–ª–∏–Ω–Ω—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–æ–º–µ—Ö–∏ —Å–≤–µ—Ä—Ö—É –∏ —Å–Ω–∏–∑—É
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:0,y:0,w:3,h:1},{x:3,y:0,w:3,h:1},{x:0,y:5,w:4,h:1},
      {x:4,y:1,w:1,h:3},{x:5,y:3,w:1,h:2}
    ],
    // 6 ‚Äî —É–∑–∫–∏–π –∫–æ—Ä–∏–¥–æ—Ä
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:3,y:0,w:1,h:3},{x:4,y:0,w:1,h:2},{x:5,y:1,w:1,h:3},
      {x:0,y:4,w:2,h:1},{x:0,y:0,w:1,h:3},{x:2,y:3,w:1,h:3}
    ],
    // 7 ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä—ë–¥
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:2,y:0,w:1,h:3},{x:4,y:0,w:1,h:4},{x:5,y:0,w:1,h:2},
      {x:0,y:0,w:2,h:1},{x:0,y:3,w:3,h:1},{x:1,y:4,w:1,h:2}
    ],
    // 8 ‚Äî –ø–ª–æ—Ç–Ω–∞—è –ø—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:3,y:0,w:1,h:4},{x:4,y:1,w:1,h:3},{x:5,y:0,w:1,h:2},
      {x:0,y:0,w:2,h:1},{x:0,y:4,w:3,h:1},{x:2,y:5,w:2,h:1}
    ],
    // 9 ‚Äî –∏–∑–ª–æ–º–∞–Ω–Ω—ã–π –ø—É—Ç—å
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:3,y:0,w:1,h:2},{x:4,y:0,w:1,h:3},{x:5,y:1,w:1,h:3},
      {x:2,y:4,w:3,h:1},{x:0,y:4,w:1,h:2},{x:0,y:0,w:2,h:1}
    ],
    // 10 ‚Äî –Ω—É–∂–µ–Ω ¬´–ª–∏—Ñ—Ç–æ–≤—ã–π¬ª –º–∞–Ω—ë–≤—Ä
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:3,y:0,w:1,h:3},{x:4,y:1,w:1,h:3},{x:5,y:3,w:1,h:3},
      {x:2,y:1,w:2,h:1},{x:0,y:4,w:3,h:1},{x:0,y:0,w:1,h:3}
    ],
    // 11 ‚Äî —Å–ª–æ–∂–Ω–µ–µ, –º–Ω–æ–≥–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:2,y:0,w:1,h:3},{x:3,y:0,w:1,h:4},{x:4,y:2,w:1,h:3},{x:5,y:0,w:1,h:2},
      {x:0,y:0,w:2,h:1},{x:0,y:4,w:3,h:1}
    ],
    // 12 ‚Äî –¥–ª–∏–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:3,y:0,w:1,h:3},{x:4,y:3,w:1,h:3},{x:5,y:0,w:1,h:2},
      {x:2,y:0,w:2,h:1},{x:0,y:4,w:4,h:1}
    ],
    // 13 ‚Äî "–±—É—Ç—ã–ª–æ—á–Ω–æ–µ –≥–æ—Ä–ª—ã—à–∫–æ"
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:3,y:0,w:1,h:4},{x:4,y:0,w:1,h:2},{x:5,y:2,w:1,h:3},
      {x:0,y:1,w:2,h:1},{x:0,y:4,w:3,h:1}
    ],
    // 14 ‚Äî –ø–æ—á—Ç–∏ –≤—Å—ë —Å–ø—Ä–∞–≤–∞, –º–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–π
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:3,y:0,w:1,h:5},{x:4,y:1,w:1,h:3},{x:5,y:0,w:1,h:2},
      {x:0,y:0,w:2,h:1},{x:0,y:4,w:2,h:1},{x:2,y:5,w:2,h:1}
    ],
    // 15 ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    [
      {x:0,y:2,w:2,h:1,red:true},
      {x:2,y:1,w:1,h:4},{x:3,y:0,w:1,h:3},{x:4,y:2,w:1,h:3},{x:5,y:0,w:1,h:2},
      {x:0,y:0,w:2,h:1},{x:0,y:4,w:3,h:1}
    ]
  ];
  const SECRET_LEVELS = [
    // S1 ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∑–∞ –ø–æ–±–µ–¥—É –±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ —Ö–æ—Ç—è –±—ã –Ω–∞ 1 —É—Ä–æ–≤–Ω–µ
    [
      {x:1,y:2,w:2,h:1,red:true},
      {x:2,y:0,w:1,h:5},{x:4,y:0,w:1,h:3},{x:5,y:1,w:1,h:3},
      {x:0,y:0,w:2,h:1},{x:0,y:4,w:3,h:1}
    ],
    // S2 ‚Äî –∑–∞ 3‚≠ê –Ω–∞ –ª—é–±–æ–º —É—Ä–æ–≤–Ω–µ
    [
      {x:0,y:2,w:2,h:1,red:true},
      {x:2,y:0,w:1,h:4},{x:3,y:2,w:1,h:4},{x:5,y:0,w:1,h:3},
      {x:0,y:0,w:3,h:1},{x:0,y:4,w:3,h:1}
    ]
  ];
  levelTotalEl.textContent = LEVELS.length;

  // "–ü–ê–†" —Ö–æ–¥–æ–≤ –¥–ª—è –∑–≤—ë–∑–¥ (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–ª–∏)
  const PAR = {1:8,2:10,3:12,4:12,5:13,6:14,7:15,8:16,9:16,10:18,11:18,12:18,13:19,14:20,15:21};

  // ======= –õ–û–ö–ê–õ–¨–ù–´–ô –ü–†–û–ì–†–ï–°–° =======
  const store = {
    load(){
      try { return JSON.parse(localStorage.getItem('unblock-progress')) || {unlocked:1,best:{},ach:{},secret:false,theme:'light'} } catch { return {unlocked:1,best:{},ach:{},secret:false,theme:'light'} }
    },
    save(data){ localStorage.setItem('unblock-progress', JSON.stringify(data)); }
  };
  let progress = store.load();

  // ======= –ê–ß–ò–í–ö–ò =======
  const ACH = {
    FIRST_WIN: '–ü–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞',
    NO_HINT_WIN: '–ü–æ–±–µ–¥–∞ –±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫',
    THREE_STARS: '–¢—Ä–∏ –∑–≤–µ–∑–¥—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ',
    FIVE_LEVELS: '–ü—Ä–æ–π–¥–∏ 5 —É—Ä–æ–≤–Ω–µ–π',
  };
  function unlockAch(key){
    if (progress.ach[key]) return;
    progress.ach[key] = true; store.save(progress);
    showToast('–ê—á–∏–≤–∫–∞: ' + key + ' ‚ú®');
    renderAch();
    // –°–µ–∫—Ä–µ—Ç–Ω—ã–µ —É—Ä–æ–≤–Ω–∏
    if ((key===ACH.NO_HINT_WIN || key===ACH.THREE_STARS) && !progress.secret){
      progress.secret = true; store.save(progress);
      showToast('–û—Ç–∫—Ä—ã—Ç—ã —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ —É—Ä–æ–≤–Ω–∏! ‚ùì');
      appendSecretLevels();
      buildLevelGrid();
    }
  }
  function renderAch(){
    const items = Object.values(ACH).map(name => {
      const done = Object.keys(progress.ach).find(k=>k===name);
      const owned = Object.values(progress.ach).includes(true) && progress.ach[name];
      const has = progress.ach[name] ? '‚úÖ' : '‚¨úÔ∏è';
      return `${has} ${name}`;
    });
    achList.innerHTML = items.map(i=>`<div style="margin:6px 0">${i}</div>`).join('');
  }

  function showToast(text){
    toast.textContent = text; toast.style.display = 'block';
    setTimeout(()=>{ toast.style.display='none'; }, 1600);
  }

  function appendSecretLevels(){
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –≤ –∫–æ–Ω–µ—Ü, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
    if (LEVELS.length===15){
      SECRET_LEVELS.forEach(l=>LEVELS.push(l));
      levelTotalEl.textContent = LEVELS.length;
    }
  }

  // ======= –£–¢–ò–õ–ò–¢–´ =======
  function show(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function overlaps1D(aStart, aEnd, bStart, bEnd){ return aStart < bEnd && aEnd > bStart; }
  function isHorizontal(b){ return b.w > 1; }
  function px(n){ return `${n}px`; }
  function deepClone(level){ return level.map(b=>({...b})); }
  function shallowState(){ return blocks.map(b=>({x:+b.x,y:+b.y})); }
  function restoreState(state){ state.forEach((p,i)=>{ blocks[i].x=p.x; blocks[i].y=p.y; placeNode(blocks[i]); }); layoutExit(); }

  function layoutExit(){
    const red = blocks.find(b=>b.red);
    exitRow = Math.round(red.y);
    document.documentElement.style.setProperty('--exit-row', exitRow);
  }

  // –¥–∏–∞–ø–∞–∑–æ–Ω –¥–≤–∏–∂–µ–Ω–∏—è –±–ª–æ–∫–∞ —Å —É—á—ë—Ç–æ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –¥—Ä—É–≥–∏—Ö –±–ª–æ–∫–æ–≤
  function allowedRange(block){
    let minX = 0, maxX = SIZE - block.w; // –ø–æ X
    let minY = 0, maxY = SIZE - block.h; // –ø–æ Y

    if (isHorizontal(block)){
      const y1 = block.y, y2 = block.y + block.h;
      for (const o of blocks){ if (o === block) continue;
        const oy1 = o.y, oy2 = o.y + o.h;
        if (!overlaps1D(y1, y2, oy1, oy2)) continue; // –Ω–µ –º–µ—à–∞–µ—Ç –ø–æ X
        if (o.x + o.w <= block.x){ minX = Math.max(minX, o.x + o.w); }
        if (o.x >= block.x + block.w){ maxX = Math.min(maxX, o.x - block.w); }
      }
      return {min: minX, max: maxX, axis:'x'};
    } else {
      const x1 = block.x, x2 = block.x + block.w;
      for (const o of blocks){ if (o === block) continue;
        const ox1 = o.x, ox2 = o.x + o.w;
        if (!overlaps1D(x1, x2, ox1, ox2)) continue;
        if (o.y + o.h <= block.y){ minY = Math.max(minY, o.y + o.h); }
        if (o.y >= block.y + block.h){ maxY = Math.min(maxY, o.y - block.h); }
      }
      return {min: minY, max: maxY, axis:'y'};
    }
  }

  function placeNode(b){
    let el = nodes.get(b.id);
    if (!el){
      el = document.createElement('div');
      el.className = 'block' + (b.red? ' red' : '');
      el.dataset.id = b.id;
      // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è ¬´–ø–∞–¥–µ–Ω–∏–µ¬ª
      el.style.transform = 'translateY(-20px)';
      setTimeout(()=>{ el.style.transform = 'translateY(0)'; }, 20);
      board.appendChild(el); nodes.set(b.id, el); enableDrag(el, b);
    }
    el.style.width = px(b.w*CELL - 4);
    el.style.height = px(b.h*CELL - 4);
    el.style.left = px(8 + b.x*CELL + 0);
    el.style.top  = px(8 + b.y*CELL + 0);
  }

  function renderAll(){ for (const b of blocks) placeNode(b); }

  function resetLevel(){
    nodes.forEach(n=>n.remove()); nodes.clear();
    blocks = deepClone(LEVELS[currentLevel]).map((b,idx)=>({...b,id:idx}));
    moves = 0; movesEl.textContent = moves; levelLabel.textContent = currentLevel+1;
    undoStack = []; hintsLeft = HINTS_PER_LEVEL; hintLeftEl.textContent = hintsLeft; usedHintThisLevel = false; clearHint();
    layoutExit();
    renderAll();
    updateStars();
  }

  function loadLevel(idx){ currentLevel = idx; resetLevel(); }

  // ======= –ó–í–Å–ó–î–´ =======
  function starString(m){
    const par = PAR[currentLevel+1] || 15;
    if (m <= par) return '‚òÖ‚òÖ‚òÖ';
    if (m <= par+3) return '‚òÖ‚òÖ‚òÜ';
    return '‚òÖ‚òÜ‚òÜ';
  }
  function updateStars(){ starsEl.textContent = starString(moves); }

  function winAnimationThen(cb){
    const red = blocks.find(b=>b.red);
    const el = nodes.get(red.id);
    const dist = (SIZE - (red.x + red.w));
    red.x = red.x + dist + 0.01; // —á—É—Ç—å –¥–∞–ª—å—à–µ –∫—Ä–∞—è
    el.style.transition = 'left .35s ease';
    placeNode(red);
    setTimeout(()=>{ el.style.transition = ''; cb && cb(); }, 360);
  }

  function win(){
    const haveNext = currentLevel < LEVELS.length - 1;
    const best = progress.best[currentLevel+1];
    const better = !best || moves < best;

    // –∑–≤—ë–∑–¥—ã –∏ –∞—á–∏–≤–∫–∏ –¥–æ –ø–æ–∫–∞–∑–∞ –æ–≤–µ—Ä–ª–µ—è
    const stars = starString(moves);
    winStarsEl.textContent = stars;
    if (stars==='‚òÖ‚òÖ‚òÖ') unlockAch(ACH.THREE_STARS);

    // –æ—Ç–º–µ–Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ ‚Äî –∑–∞—Å—á–∏—Ç–∞–µ–º –∞—á–∏–≤–∫—É ¬´–±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫¬ª
    if (!usedHintThisLevel) unlockAch(ACH.NO_HINT_WIN);

    if (progress.unlocked < currentLevel + 2){ progress.unlocked = currentLevel + 2; }
    if (better){ progress.best[currentLevel+1] = moves; }
    store.save(progress); buildLevelGrid();

    // –ø–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞ / 5 —É—Ä–æ–≤–Ω–µ–π
    unlockAch(ACH.FIRST_WIN);
    if (progress.unlocked >= 6) unlockAch(ACH.FIVE_LEVELS);

    document.getElementById('winText').innerHTML = better ? `–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥: <b>${moves}</b> —Ö–æ–¥(–æ–≤)!` : `–•–æ–¥—ã: <b>${moves}</b>. –õ—É—á—à–∏–π: <b>${best}</b>.`;
    nextBtn.textContent = haveNext ? '–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å' : '–°—ã–≥—Ä–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞';

    winAnimationThen(()=> overlay.classList.add('show'));
  }

  function checkWin(){
    const red = blocks.find(b=>b.red);
    if (Math.round(red.y) === exitRow && red.x + red.w >= SIZE) win();
  }

  // ======= DRAG / UNDO =======
  function pushUndo(){
    undoStack.push(shallowState());
    if (undoStack.length > UNDO_DEPTH) undoStack.shift();
  }
  function undo(){
    if (!undoStack.length) return;
    const prev = undoStack.pop();
    restoreState(prev);
    if (moves>0){ moves--; movesEl.textContent = moves; updateStars(); }
  }

  function enableDrag(el, block){
    el.addEventListener('pointerdown', (ev)=>{
      ev.preventDefault();
      el.setPointerCapture(ev.pointerId);
      dragging = block; el.style.cursor = 'grabbing'; el.classList.add('active');
      dragStart = {x:ev.clientX, y:ev.clientY};
      startPos = {x:block.x, y:block.y};
      const range = allowedRange(block);

      const onMove = (e)=>{
        const dx = (e.clientX - dragStart.x) / CELL;
        const dy = (e.clientY - dragStart.y) / CELL;
        if (range.axis === 'x'){
          let nx = startPos.x + dx; nx = clamp(nx, range.min, range.max); block.x = nx; placeNode(block);
        } else {
          let ny = startPos.y + dy; ny = clamp(ny, range.min, range.max); block.y = ny; placeNode(block);
        }
      };

      const onUp = ()=>{
        el.releasePointerCapture(ev.pointerId);
        el.style.cursor = 'grab'; el.classList.remove('active');
        board.removeEventListener('pointermove', onMove);
        window.removeEventListener('pointerup', onUp);
        if (startPos.x !== block.x || startPos.y !== block.y){ pushUndo(); moves++; movesEl.textContent = moves; updateStars(); }
        checkWin();
      };

      board.addEventListener('pointermove', onMove);
      window.addEventListener('pointerup', onUp);
    });
  }

// ======= –ü–û–î–°–ö–ê–ó–ö–ê =======
-

function computeLevelSolution(blocks){
    // BFS –¥–ª—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –¥–æ –≤—ã—Ö–æ–¥–∞ –∫—Ä–∞—Å–Ω–æ–≥–æ –±–ª–æ–∫–∞
    const N = blocks.length;
    const redIdx = blocks.findIndex(b=>b.red);
    const sizes = blocks.map(b=>({w:b.w,h:b.h,horiz:b.w>1}));
    const start = blocks.map(b=>({x:b.x,y:b.y}));

    const encode = st => st.map(p=>p.x+','+p.y).join('|');
    const overlaps1D_local = (a1,a2,b1,b2)=> a1 < b2 && a2 > b1;

    function allowedRangeState(st,i){
        const S = sizes[i];
        const cur = st[i];
        if(S.horiz){
            let min=0,max=SIZE-S.w;
            const y1=cur.y,y2=cur.y+S.h;
            for(let j=0;j<st.length;j++){ if(j===i) continue; const Sj=sizes[j],p=st[j]; const oy1=p.y,oy2=p.y+Sj.h; if(!overlaps1D_local(y1,y2,oy1,oy2)) continue; if(p.x+Sj.w<=cur.x) min=Math.max(min,p.x+Sj.w); if(p.x>=cur.x+S.w) max=Math.min(max,p.x-S.w); }
            return {axis:'x',min,max};
        } else {
            let min=0,max=SIZE-S.h;
            const x1=cur.x,x2=cur.x+S.w;
            for(let j=0;j<st.length;j++){ if(j===i) continue; const Sj=sizes[j],p=st[j]; const ox1=p.x,ox2=p.x+Sj.w; if(!overlaps1D_local(x1,x2,ox1,ox2)) continue; if(p.y+Sj.h<=cur.y) min=Math.max(min,p.y+Sj.h); if(p.y>=cur.y+S.h) max=Math.min(max,p.y-S.h); }
            return {axis:'y',min,max};
        }
    }

    const goal = st => { const r=st[redIdx],RS=sizes[redIdx]; return r.x+RS.w>=SIZE; };

    const q=[{st:start,move:null,prev:null}];
    const seen=new Set([encode(start)]);
    let found=null,iters=0,LIMIT=10000;

    while(q.length && iters++<LIMIT){
        const node = q.shift();
        if(goal(node.st)){ found=node; break; }
        for(let i=0;i<N;i++){
            const cur=node.st[i];
            const range=allowedRangeState(node.st,i);
            const opts=[];
            if(range.axis==='x'){ if(range.min!==cur.x) opts.push(range.min); if(range.max!==cur.x && range.max!==range.min) opts.push(range.max);
                for(const nx of opts){ const st2=node.st.map(p=>({...p})); st2[i].x=nx; const key=encode(st2); if(seen.has(key)) continue; seen.add(key); q.push({st:st2,move:{i,axis:'x',from:cur.x,to:nx},prev:node}); }}
            else{ if(range.min!==cur.y) opts.push(range.min); if(range.max!==cur.y && range.max!==range.min) opts.push(range.max);
                for(const ny of opts){ const st2=node.st.map(p=>({...p})); st2[i].y=ny; const key=encode(st2); if(seen.has(key)) continue; seen.add(key); q.push({st:st2,move:{i,axis:'y',from:cur.y,to:ny},prev:node}); }}
        }
    }

    const steps=[];
    if(found){
        let first=found; const path=[];
        while(first.prev){ path.push(first.move); first=first.prev; }
        path.reverse();
        for(const mv of path) steps.push({blockIdx:mv.i,axis:mv.axis,to:mv.to});
    }
    return steps;
}


  
  // ======= –í–´–ë–û–† –£–†–û–í–ù–Ø =======
  function buildLevelGrid(){
    levelGrid.innerHTML = '';
    for (let i=1;i<=LEVELS.length;i++){
      const btn = document.createElement('button');
      btn.className = 'lvlBtn';
      btn.innerHTML = `${i}`;
      const isLocked = i > progress.unlocked;
      if (isLocked){ btn.classList.add('locked'); const lock = document.createElement('div'); lock.className='lock'; lock.textContent='üîí'; btn.appendChild(lock); }
      const best = progress.best[i];
      if (best){ const b = document.createElement('div'); b.className='badge good'; b.style.position='absolute'; b.style.bottom='6px'; b.style.left='6px'; b.textContent = best + ' —Ö.'; btn.appendChild(b); }
      btn.addEventListener('click', ()=>{ if (isLocked) return; show('game'); loadLevel(i-1); });
      levelGrid.appendChild(btn);
    }
  }

  // ======= –¢–ï–ú–´ =======
  function applyTheme(){
    const dark = progress.theme === 'dark';
    document.body.classList.toggle('theme-dark', dark);
    themeName.textContent = dark ? '–¢—ë–º–Ω–∞—è' : '–°–≤–µ—Ç–ª–∞—è';
    themeName2.textContent = dark ? '–¢—ë–º–Ω–∞—è' : '–°–≤–µ—Ç–ª–∞—è';
  }
  function toggleTheme(){
    progress.theme = (progress.theme==='dark') ? 'light' : 'dark';
    store.save(progress); applyTheme();
  }

  // ======= –ù–ê–í–ò–ì–ê–¶–ò–Ø =======
  function initNav(){
    playBtn.addEventListener('click', ()=>{ show('game'); loadLevel(0); });
    chooseBtn.addEventListener('click', ()=>{ show('levelSelect'); buildLevelGrid(); });
    backFromSelect.addEventListener('click', ()=>{ show('menu'); });
    toSelectBtn.addEventListener('click', ()=>{ show('levelSelect'); buildLevelGrid(); });
    toMenuBtn.addEventListener('click', ()=>{ show('menu'); });
    resetBtn.addEventListener('click', ()=> resetLevel());
    hintBtn.addEventListener('click', showHint);
    undoBtn.addEventListener('click', undo);

    nextBtn.addEventListener('click', ()=>{
      overlay.classList.remove('show');
      const haveNext = currentLevel < LEVELS.length-1;
      if (haveNext){ loadLevel(currentLevel+1); show('game'); }
      else { show('levelSelect'); buildLevelGrid(); }
    });
    closeWinBtn.addEventListener('click', ()=>{ overlay.classList.remove('show'); show('levelSelect'); buildLevelGrid(); });

    achBtn.addEventListener('click', ()=>{ renderAch(); document.getElementById('achOverlay').style.display='flex'; });
    closeAch.addEventListener('click', ()=>{ document.getElementById('achOverlay').style.display='none'; });

    themeBtn.addEventListener('click', toggleTheme);
    themeBtnInGame.addEventListener('click', toggleTheme);
  }

  // ======= –ò–ù–ò–¢ =======
  function init(){
    document.documentElement.style.setProperty('--cell', CELL + 'px');
    if (progress.secret) appendSecretLevels();
    applyTheme();
    levelTotalEl.textContent = LEVELS.length;
    buildLevelGrid();
    initNav();
  }

  init();
})();
</script>
</body>
</html>
